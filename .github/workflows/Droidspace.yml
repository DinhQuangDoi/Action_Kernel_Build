name: Build Kernel (Droidspaces Script)

on:
  workflow_dispatch:
    inputs:
      KERNEL_SOURCE:
        description: 'Link Source Kernel (Full Git URL)'
        required: true
        default: 'https://github.com/ravindu644/android_kernel_realme_sm8250-droidspaces'
      KERNEL_BRANCH:
        description: 'Branch'
        required: true
        default: 'main'
      DEFCONFIG:
        description: 'List of configs (Space separated)'
        required: true
        default: 'vendor/kona-perf_defconfig vendor/oplus.config droidspaces.config'
      TOOLCHAIN_URL:
        description: 'Link Toolchain'
        required: true
        default: 'https://gitlab.com/provasishh/clang-20.git'
      ANYKERNEL_URL:
        description: 'Link AnyKernel3'
        required: true
        default: 'https://github.com/provasish/AnyKernel3.git'

jobs:
  Build-Kernel:
    runs-on: ubuntu-latest
    permissions: write-all
    
    steps:
      # 1. Cài đặt môi trường
      - name: Cleanup & Install Dependencies
        run: |
          rm -rf ${{ github.workspace }}/*
          sudo apt-get update
          sudo apt-get install -y build-essential bc cpio llvm clang bison flex libssl-dev libfl-dev \
            curl git wget libarchive-tools python-is-python3 zip unzip tar gzip \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      # 2. Clone Kernel Source (SỬA LỖI: Dùng git clone thay vì actions/checkout)
      - name: Clone Kernel Source
        run: |
          echo "--- Cloning Kernel ---"
          # Clone đệ quy (recursive) để lấy luôn submodule nếu có
          git clone --recursive --depth=1 ${{ github.event.inputs.KERNEL_SOURCE }} -b ${{ github.event.inputs.KERNEL_BRANCH }} kernel

      # 3. Clone Toolchain & AnyKernel (Chạy bên trong thư mục kernel vừa clone)
      - name: Setup Toolchain & AnyKernel
        run: |
          cd ${{ github.workspace }}/kernel
          
          echo "--- Cloning AnyKernel ---"
          git clone --depth=1 ${{ github.event.inputs.ANYKERNEL_URL }} anykernel

          echo "--- Cloning Toolchain ---"
          git clone --depth=1 ${{ github.event.inputs.TOOLCHAIN_URL }} tc

      # 4. BUILD KERNEL
      - name: Compile Kernel
        run: |
          cd ${{ github.workspace }}/kernel
          
          # Thiết lập biến theo đúng script gốc
          KERNEL_OUT=$(pwd)/out
          mkdir -p $KERNEL_OUT
          
          # Đường dẫn Toolchain (Dựa trên script gốc: tc nằm trong thư mục kernel)
          CLANG_BIN=$(pwd)/tc/clang/bin/clang
          CROSS_COMPILE_PATH=$(pwd)/tc/aarch64-linux-android-4.9/bin/aarch64-linux-android-
          
          # Biến môi trường Build
          export KERNEL_SRC=$KERNEL_OUT
          export CLANG_TRIPLE=aarch64-linux-gnu-
          
          # Build Options
          BUILD_ARGS=(
            O=$KERNEL_OUT
            CC=$CLANG_BIN
            LLVM_IAS=1
            ARCH=arm64
            CROSS_COMPILE=$CROSS_COMPILE_PATH
            NM=llvm-nm
            OBJCOPY=llvm-objcopy
            OBJDUMP=llvm-objdump
            STRIP=llvm-strip
          )

          echo "--- Applying Configs: ${{ github.event.inputs.DEFCONFIG }} ---"
          # Chạy make config (gộp nhiều config lại)
          make "${BUILD_ARGS[@]}" ${{ github.event.inputs.DEFCONFIG }}

          echo "--- Starting Compilation ---"
          # Chạy build
          make "${BUILD_ARGS[@]}" -j$(nproc --all)

      # 5. Đóng gói
      - name: Zipping Kernel
        run: |
          cd ${{ github.workspace }}/kernel
          DT=$(date +"%Y%m%d-%H%M")
          ZIP_NAME="Droidspaces-El-Diablo-AOSP-${DT}.zip"
          
          # Đường dẫn file output
          IMG_PATH="out/arch/arm64/boot/Image"
          DTBO_PATH="out/arch/arm64/boot/dtbo.img"
          DTB_PATH="out/arch/arm64/boot/dtb"

          if [ ! -f "$IMG_PATH" ]; then
            echo "Lỗi: Không tìm thấy file Image tại $IMG_PATH! Build thất bại."
            ls -R out/arch/arm64/boot/
            exit 1
          fi

          echo "--- Zipping Kernel ---"
          cd anykernel
          rm -f *.zip
          
          # Copy Image
          cp "../$IMG_PATH" .
          
          # Copy dtbo (nếu có)
          if [ -f "../$DTBO_PATH" ]; then
             echo "Found dtbo.img"
             cp "../$DTBO_PATH" .
          fi
          
          # Copy dtb (nếu có)
          if [ -f "../$DTB_PATH" ]; then
             echo "Found dtb"
             cp "../$DTB_PATH" .
          fi
          
          # Nén file zip
          zip -r9 "$ZIP_NAME" * -x .git README.md *placeholder
          
          # Di chuyển ra folder release
          mkdir -p ../final_zip
          mv "$ZIP_NAME" ../final_zip/
          
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      # 6. Upload
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ github.workspace }}/kernel/final_zip/*
          name: ${{ env.ZIP_NAME }}
          tag_name: ${{ github.run_id }}
          body: |
             Build Date: $(date)
             Source: ${{ github.event.inputs.KERNEL_SOURCE }}
             Config: ${{ github.event.inputs.DEFCONFIG }}
